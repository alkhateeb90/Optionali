{% extends "base.html" %}

{% block title %}Dashboard - Enhanced Options Trading Platform{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- System Overview Cards -->
<div class="grid grid-4">
    <div class="card metric-card">
        <div class="metric-value" id="total-opportunities">0</div>
        <div class="metric-label">Golden Opportunities</div>
    </div>
    <div class="card metric-card">
        <div class="metric-value" id="active-positions">0</div>
        <div class="metric-label">Active Positions</div>
    </div>
    <div class="card metric-card">
        <div class="metric-value" id="pending-orders">0</div>
        <div class="metric-label">Pending Orders</div>
    </div>
    <div class="card metric-card">
        <div class="metric-value" id="daily-pnl">$0</div>
        <div class="metric-label">Daily P&L</div>
    </div>
</div>

<!-- Two-Staged Intelligence System Overview -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Two-Staged Intelligence System</h2>
        <button class="btn btn-primary" onclick="startManualScan()">
            <span class="material-icons">search</span>
            Manual Scan
        </button>
    </div>
    
    <div class="grid grid-2">
        <!-- Stage 1: Champion Screener -->
        <div class="stage-panel">
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                <span class="material-icons" style="vertical-align: middle;">filter_1</span>
                Stage 1: Champion Screener
            </h3>
            
            <div class="detection-layers">
                <div class="layer-item">
                    <div class="layer-header">
                        <span class="layer-number">1</span>
                        <span class="layer-name">Universe Filter</span>
                        <span class="layer-count" id="universe-count">5000 → 500</span>
                    </div>
                    <div class="layer-description">Market cap, volume, options availability</div>
                </div>
                
                <div class="layer-item">
                    <div class="layer-header">
                        <span class="layer-number">2</span>
                        <span class="layer-name">Momentum Radar</span>
                        <span class="layer-count" id="momentum-count">500 → 100</span>
                    </div>
                    <div class="layer-description">Velocity spikes, oversold extremes, squeeze building</div>
                </div>
                
                <div class="layer-item">
                    <div class="layer-header">
                        <span class="layer-number">3</span>
                        <span class="layer-name">Golden Hunter</span>
                        <span class="layer-count" id="golden-count">100 → 0</span>
                    </div>
                    <div class="layer-description">High-probability pattern recognition</div>
                </div>
            </div>
        </div>
        
        <!-- Stage 2: Options Intelligence -->
        <div class="stage-panel">
            <h3 style="color: var(--secondary-color); margin-bottom: 15px;">
                <span class="material-icons" style="vertical-align: middle;">filter_2</span>
                Stage 2: Options Intelligence
            </h3>
            
            <div class="intelligence-metrics">
                <div class="metric-row">
                    <span class="metric-name">Contracts Analyzed</span>
                    <span class="metric-value" id="contracts-analyzed">1000+</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Strategy Types</span>
                    <span class="metric-value">4 (Calls, Puts, Spreads, LEAPs)</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Best Contracts</span>
                    <span class="metric-value">Top 3 per strategy</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Analysis Time</span>
                    <span class="metric-value" id="analysis-time">< 1 second</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Market Summary -->
<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Market Summary</h2>
            <span class="market-regime" id="market-regime">BULLISH</span>
        </div>
        
        <div class="market-indicators">
            <div class="indicator-row">
                <span class="indicator-name">SPY</span>
                <span class="indicator-value" id="spy-price">$446.59</span>
                <span class="indicator-change positive" id="spy-change">+1.05%</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">QQQ</span>
                <span class="indicator-value" id="qqq-price">$378.42</span>
                <span class="indicator-change positive" id="qqq-change">+0.85%</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">VIX</span>
                <span class="indicator-value" id="vix-price">18.5</span>
                <span class="indicator-status" id="vix-status">NORMAL</span>
            </div>
            <div class="indicator-row">
                <span class="indicator-name">SPY RSI</span>
                <span class="indicator-value" id="spy-rsi">59.1</span>
                <span class="indicator-status">NEUTRAL</span>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Account Summary</h2>
            <span class="account-number">U4312675</span>
        </div>
        
        <div class="account-metrics">
            <div class="metric-row">
                <span class="metric-name">Total Value</span>
                <span class="metric-value" id="total-value">$125,000</span>
            </div>
            <div class="metric-row">
                <span class="metric-name">Cash</span>
                <span class="metric-value" id="cash-balance">$15,000</span>
            </div>
            <div class="metric-row">
                <span class="metric-name">Positions</span>
                <span class="metric-value" id="positions-value">$110,000</span>
            </div>
            <div class="metric-row">
                <span class="metric-name">Buying Power</span>
                <span class="metric-value" id="buying-power">$45,000</span>
            </div>
        </div>
    </div>
</div>

<!-- Golden Opportunities -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Live Golden Opportunities</h2>
        <div class="opportunity-stats">
            <span class="stat-item">
                <span class="material-icons">star</span>
                <span id="opportunities-today">0 today</span>
            </span>
            <span class="stat-item">
                <span class="material-icons">schedule</span>
                <span id="next-scan">Next scan: 5 min</span>
            </span>
        </div>
    </div>
    
    <div id="opportunities-container">
        <div class="empty-state">
            <span class="material-icons" style="font-size: 3rem; opacity: 0.3;">search</span>
            <p>No golden opportunities found in current market conditions</p>
            <p style="opacity: 0.7; font-size: 0.9rem;">Scanner running every 5 minutes</p>
        </div>
    </div>
</div>

<!-- System Status -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">System Status</h2>
        <button class="btn btn-secondary" onclick="refreshSystemStatus()">
            <span class="material-icons">refresh</span>
            Refresh
        </button>
    </div>
    
    <div class="grid grid-3">
        <div class="status-card">
            <div class="status-header">
                <span class="material-icons">account_balance</span>
                <span>IBKR Connection</span>
            </div>
            <div class="status-details" id="ibkr-details">
                <div class="status-value">Disconnected</div>
                <div class="status-info">Port 4002 • Account U4312675</div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-header">
                <span class="material-icons">search</span>
                <span>Champion Scanner</span>
            </div>
            <div class="status-details" id="scanner-details">
                <div class="status-value">0 opportunities</div>
                <div class="status-info">0 golden • Last scan: Never</div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-header">
                <span class="material-icons">telegram</span>
                <span>Telegram Alerts</span>
            </div>
            <div class="status-details" id="telegram-details">
                <div class="status-value">0 alerts sent</div>
                <div class="status-info">$0.00 total cost • 100% success</div>
            </div>
        </div>
    </div>
</div>

<style>
.stage-panel {
    background-color: var(--surface-variant);
    border-radius: 8px;
    padding: 20px;
}

.detection-layers {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.layer-item {
    background-color: var(--surface);
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid var(--primary-color);
}

.layer-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
}

.layer-number {
    background-color: var(--primary-color);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}

.layer-name {
    font-weight: 500;
    flex: 1;
}

.layer-count {
    font-size: 0.9rem;
    color: var(--primary-color);
    font-weight: 500;
}

.layer-description {
    font-size: 0.85rem;
    opacity: 0.7;
    margin-left: 34px;
}

.intelligence-metrics {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--surface-variant);
}

.metric-row:last-child {
    border-bottom: none;
}

.metric-name {
    font-size: 0.9rem;
    opacity: 0.8;
}

.market-regime {
    background-color: var(--success);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.market-indicators {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.indicator-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
}

.indicator-name {
    font-weight: 500;
    min-width: 60px;
}

.indicator-value {
    font-weight: 500;
    color: var(--on-surface);
}

.indicator-change.positive {
    color: var(--success);
}

.indicator-change.negative {
    color: var(--error);
}

.indicator-status {
    font-size: 0.8rem;
    padding: 2px 8px;
    border-radius: 8px;
    background-color: var(--surface-variant);
}

.account-number {
    background-color: var(--primary-color);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.account-metrics {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.opportunity-stats {
    display: flex;
    gap: 20px;
    align-items: center;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
    opacity: 0.8;
}

.empty-state {
    text-align: center;
    padding: 40px;
    opacity: 0.6;
}

.status-card {
    background-color: var(--surface-variant);
    border-radius: 8px;
    padding: 15px;
}

.status-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    font-size: 0.9rem;
    font-weight: 500;
}

.status-details {
    margin-left: 32px;
}

.status-value {
    font-weight: 500;
    margin-bottom: 5px;
}

.status-info {
    font-size: 0.8rem;
    opacity: 0.7;
}

@media (max-width: 768px) {
    .grid-4 {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .opportunity-stats {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Dashboard specific JavaScript
let socket;
let systemData = {};

document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    connectWebSocket();
    loadSystemStatus();
    
    // Auto-refresh every 30 seconds
    setInterval(loadSystemStatus, 30000);
});

function initializeDashboard() {
    console.log('Dashboard initialized for account U4312675');
}

function connectWebSocket() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('Connected to WebSocket');
        updateConnectionStatus('connected');
    });
    
    socket.on('disconnect', function() {
        console.log('Disconnected from WebSocket');
        updateConnectionStatus('disconnected');
    });
    
    socket.on('system_status', function(data) {
        updateSystemStatus(data);
    });
    
    socket.on('scan_results', function(data) {
        updateScanResults(data);
    });
    
    socket.on('golden_opportunity', function(data) {
        addGoldenOpportunity(data);
    });
}

function loadSystemStatus() {
    fetch('/api/system-status')
        .then(response => response.json())
        .then(data => {
            systemData = data;
            updateSystemStatus(data);
        })
        .catch(error => {
            console.error('Error loading system status:', error);
        });
}

function updateSystemStatus(data) {
    // Update top bar indicators
    updateStatusIndicator('ibkr-status', data.ibkr_connected, 'IBKR');
    updateStatusIndicator('data-status', data.market_data_active, 'Data');
    updateStatusIndicator('scanner-status', data.scanner_running, 'Scanner');
    
    // Update metrics
    document.getElementById('total-opportunities').textContent = data.opportunities_count || 0;
    document.getElementById('active-positions').textContent = data.positions_count || 0;
    document.getElementById('pending-orders').textContent = data.orders_count || 0;
    document.getElementById('daily-pnl').textContent = formatCurrency(data.daily_pnl || 0);
    
    // Update layer counts
    if (data.scan_results) {
        document.getElementById('universe-count').textContent = `${data.scan_results.universe_size || 5000} → ${data.scan_results.filtered_size || 500}`;
        document.getElementById('momentum-count').textContent = `${data.scan_results.filtered_size || 500} → ${data.scan_results.champions_size || 100}`;
        document.getElementById('golden-count').textContent = `${data.scan_results.champions_size || 100} → ${data.scan_results.golden_size || 0}`;
    }
    
    // Update market data
    if (data.market_data) {
        updateMarketData(data.market_data);
    }
    
    // Update account data
    if (data.account_data) {
        updateAccountData(data.account_data);
    }
    
    // Update system status cards
    updateSystemStatusCards(data);
}

function updateStatusIndicator(elementId, isConnected, label) {
    const element = document.getElementById(elementId);
    if (isConnected) {
        element.className = 'status-indicator status-connected';
        element.innerHTML = `<div class="status-dot"></div><span>${label} Connected</span>`;
    } else {
        element.className = 'status-indicator status-disconnected';
        element.innerHTML = `<div class="status-dot"></div><span>${label} Disconnected</span>`;
    }
}

function updateMarketData(data) {
    document.getElementById('spy-price').textContent = `$${data.SPY?.price || '446.59'}`;
    document.getElementById('spy-change').textContent = `${data.SPY?.change || '+1.05%'}`;
    document.getElementById('qqq-price').textContent = `$${data.QQQ?.price || '378.42'}`;
    document.getElementById('qqq-change').textContent = `${data.QQQ?.change || '+0.85%'}`;
    document.getElementById('vix-price').textContent = data.VIX?.price || '18.5';
    document.getElementById('spy-rsi').textContent = data.SPY?.rsi || '59.1';
    
    // Update market regime
    const regime = data.market_regime || 'BULLISH';
    const regimeElement = document.getElementById('market-regime');
    regimeElement.textContent = regime;
    regimeElement.className = `market-regime ${regime.toLowerCase()}`;
}

function updateAccountData(data) {
    document.getElementById('total-value').textContent = formatCurrency(data.total_value || 125000);
    document.getElementById('cash-balance').textContent = formatCurrency(data.cash || 15000);
    document.getElementById('positions-value').textContent = formatCurrency(data.positions_value || 110000);
    document.getElementById('buying-power').textContent = formatCurrency(data.buying_power || 45000);
}

function updateSystemStatusCards(data) {
    // IBKR Status
    const ibkrDetails = document.getElementById('ibkr-details');
    ibkrDetails.innerHTML = `
        <div class="status-value">${data.ibkr_connected ? 'Connected' : 'Disconnected'}</div>
        <div class="status-info">Port 4002 • Account U4312675</div>
    `;
    
    // Scanner Status
    const scannerDetails = document.getElementById('scanner-details');
    scannerDetails.innerHTML = `
        <div class="status-value">${data.opportunities_count || 0} opportunities</div>
        <div class="status-info">${data.golden_count || 0} golden • Last scan: ${data.last_scan || 'Never'}</div>
    `;
    
    // Telegram Status
    const telegramDetails = document.getElementById('telegram-details');
    telegramDetails.innerHTML = `
        <div class="status-value">${data.alerts_sent || 0} alerts sent</div>
        <div class="status-info">$${(data.alert_cost || 0).toFixed(2)} total cost • ${data.alert_success_rate || 100}% success</div>
    `;
}

function updateScanResults(data) {
    const container = document.getElementById('opportunities-container');
    
    if (data.golden_opportunities && data.golden_opportunities.length > 0) {
        container.innerHTML = '';
        data.golden_opportunities.forEach(opportunity => {
            addGoldenOpportunity(opportunity);
        });
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <span class="material-icons" style="font-size: 3rem; opacity: 0.3;">search</span>
                <p>No golden opportunities found in current market conditions</p>
                <p style="opacity: 0.7; font-size: 0.9rem;">Scanner running every 5 minutes</p>
            </div>
        `;
    }
}

function addGoldenOpportunity(opportunity) {
    const container = document.getElementById('opportunities-container');
    
    // Remove empty state if present
    const emptyState = container.querySelector('.empty-state');
    if (emptyState) {
        container.innerHTML = '';
    }
    
    const opportunityCard = document.createElement('div');
    opportunityCard.className = 'opportunity-card';
    opportunityCard.innerHTML = `
        <div class="opportunity-header">
            <div class="opportunity-symbol">${opportunity.symbol}</div>
            <div class="opportunity-score">${opportunity.score}</div>
        </div>
        <div class="opportunity-details">
            <div class="opportunity-pattern">${opportunity.pattern}</div>
            <div class="opportunity-action">${opportunity.action}</div>
        </div>
        <div class="opportunity-actions">
            <button class="btn btn-primary btn-sm" onclick="analyzeOptions('${opportunity.symbol}')">
                Analyze Options
            </button>
            <button class="btn btn-secondary btn-sm" onclick="viewDetails('${opportunity.symbol}')">
                View Details
            </button>
        </div>
    `;
    
    container.appendChild(opportunityCard);
}

function startManualScan() {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; margin-right: 8px;"></span>Scanning...';
    
    fetch('/api/champion-scan', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            console.log('Manual scan completed:', data);
            setTimeout(() => {
                button.disabled = false;
                button.innerHTML = '<span class="material-icons">search</span>Manual Scan';
            }, 3000);
        })
        .catch(error => {
            console.error('Manual scan error:', error);
            button.disabled = false;
            button.innerHTML = '<span class="material-icons">search</span>Manual Scan';
        });
}

function refreshSystemStatus() {
    loadSystemStatus();
}

function analyzeOptions(symbol) {
    window.location.href = `/trade-builder?symbol=${symbol}`;
}

function viewDetails(symbol) {
    // Open details modal or navigate to details page
    console.log('View details for:', symbol);
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

// Opportunity card styles
const opportunityStyles = `
<style>
.opportunity-card {
    background-color: var(--surface-variant);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid var(--success);
}

.opportunity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.opportunity-symbol {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary-color);
}

.opportunity-score {
    background-color: var(--success);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.opportunity-details {
    margin-bottom: 15px;
}

.opportunity-pattern {
    font-weight: 500;
    margin-bottom: 5px;
}

.opportunity-action {
    font-size: 0.9rem;
    opacity: 0.8;
}

.opportunity-actions {
    display: flex;
    gap: 10px;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 0.8rem;
}
</style>
`;

// Add styles to head
document.head.insertAdjacentHTML('beforeend', opportunityStyles);
</script>
{% endblock %}

